{"version":3,"sources":["enums/enums.js","components/Scenarios/Actions.js","enums/event-types.js","enums/edit-types.js","components/Scenarios.js","components/Doc/Tab.js","enums/y-doc-keys.js","components/Doc/Editor.js","components/Doc/Updates.js","components/Doc/YDocModel.js","components/Doc.js","scenarios/doc-edit.js","scenarios/index.js","scenarios/two-docs-sync-without-conflicts.js","scenarios/two-docs-sync-with-conflicts.js","scenarios/two-docs-sync-with-lost-updates.js","App.js","index.js"],"names":["CUSTOM_SCENARIO","Actions","props","className","onClick","onOpenDoc","DOC_OPEN","DOC_UPDATE","DOC_SYNC","DOC_CLOSE","INSERT","DELETE","stringifyStep","step","action","payload","E","type","EDIT_TYPE","id","pos","str","len","Error","undefined","index","from","to","Scenarios","SCENARIOS_ID","currentScenarioSteps","scenarios","currentScenario","currentStep","currentScenarioStepIndex","nextStep","htmlFor","onChange","e","target","value","onScenarioChange","ENUMS","Object","keys","map","scenario","disabled","length","onNextStep","onRestartStep","Tab","doc","onCloseDoc","TEXT_KEY","getTextFromYDoc","yDoc","getText","Y_DOC_KEYS","toString","Editor","editorRef","useRef","editorValue","useEffect","text","current","textContent","contentEditable","editable","onInput","cursorPos","window","getSelection","getRangeAt","startOffset","change","prev","cur","EDIT_TYPES","slice","getChanges","onEditorChange","ref","stringifyAction","Updates","createHandleSync","onSync","updates","update","docs","filter","renderMissing","missing","res","forEach","clientID","push","renderModel","sharedType","sharedTypeNode","content","client","clock","getSharedTypeId","right","YDocModel","children","store","clients","items","parent","_start","pendingStructs","Doc","DocEdit","TwoDocsSyncWithoutConflicts","TwoDocsSyncWithConflicts","TwoDocsSyncWithLostUpdates","App","useState","setCurrentScenario","setCurrentScenarioStepIndex","_setDocs","setDocs","updateDocById","updateDoc","handleOpenDoc","Y","handleCloseDoc","destroy","handleEditorChange","prevStateVector","yText","insert","delete","handleSync","toDoc","includes","Boolean","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"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K,MAGT,CACEL,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLC,IAAK,OC/BT+F,4BCJa,CACb,CAACpG,GACD,CAACA,GACD,CACEA,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLC,IAAK,QAGT,CACEL,EACA,CACEU,KAAM,EACNC,GAAI,IAGR,CACEX,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLE,IAAK,IAGT,CACEN,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLC,IAAK,MAGT,CACEL,EACA,CACEU,KAAM,EACNC,GAAI,KDpCR0F,yBELa,CACb,CAACrG,GACD,CAACA,GACD,CACEA,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLC,IAAK,QAGT,CACEL,EACA,CACEU,KAAM,EACNC,GAAI,IAGR,CACEX,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLC,IAAK,MAGT,CACEL,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLC,IAAK,MAGT,CACEL,EACA,CACEU,KAAM,EACNC,GAAI,IAGR,CACEX,EACA,CACEU,KAAM,EACNC,GAAI,KF1CR2F,2BGNa,CACb,CAACtG,GACD,CAACA,GACD,CACEA,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLC,IAAK,QAGT,CACEL,EACA,CACEU,KAAM,EACNC,GAAI,IAGR,CACEX,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLC,IAAK,MAGT,CACEL,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLC,IAAK,OAGT,CACEL,EACA,CACEG,GAAI,EACJF,KAAM8D,EACN3D,IAAK,EACLC,IAAK,MAGT,CACEL,EACA,CACEU,KAAM,EACNC,GAAI,EACJF,MAAO,IAGX,CACET,EACA,CACEU,KAAM,EACNC,GAAI,IAGR,CACEX,EACA,CACEU,KAAM,EACNC,GAAI,EACJF,MAAO,M,MC5DE,SAAS8F,IACtB,MAA8CC,mBAAS9E,GAAvD,mBAAOV,EAAP,KAAwByF,EAAxB,KACA,EAAgED,mBAAS,GAAzE,mBAAOtF,EAAP,KAAiCwF,EAAjC,KACA,EAAyBF,mBAAS,IAAlC,mBAAO9B,EAAP,KAAaiC,EAAb,KAEA,SAASC,EAAQlC,GACfiC,EAASjC,GACTlB,OAAOkB,KAAOA,EAGhB,SAASmC,EAAc1G,EAAI2G,GAMzBF,EALa,sBACRlC,EAAKV,MAAM,EAAG7D,IADN,CAEX2G,EAAUpC,EAAKvE,KAFJ,YAGRuE,EAAKV,MAAM7D,EAAK,MAsCvB,SAAS4G,IACP,IAAMvE,EAAO,IAAIwE,IACjBJ,EAAQ,GAAD,mBACFlC,GADE,CAEL,CACEvE,GAAIuE,EAAK1C,OACTQ,KAAMA,EACNgC,QAAS,OAKf,SAASyC,EAAe7E,GACtBA,EAAII,KAAK0E,UACTL,EAAczE,EAAIjC,IAAI,WACpB,OAAO,QAIX,SAASgH,EAAmBrH,GAC1B,IAAQK,EAA4BL,EAA5BK,GAAIF,EAAwBH,EAAxBG,KAAMG,EAAkBN,EAAlBM,IAAKC,EAAaP,EAAbO,IAAKC,EAAQR,EAARQ,IAC5BuG,EAAc1G,GAAI,SAAUiC,GAC1B,IAAMgF,EAAkBJ,IAAoB5E,EAAII,MAC1C6E,EAAQjF,EAAII,KAAKC,QAAQC,GAC/B,OAAQzC,GACN,KAAKC,EACHmH,EAAMC,OAAOlH,EAAKC,GAClB,MACF,KAAKH,EACHmH,EAAME,OAAOnH,EAAKE,GAClB,MACF,QACE,MAAM,IAAIC,MAAM,mBAGpB,IAAMkE,EAASuC,IAAsB5E,EAAII,KAAM4E,GAE/C,OAAO,2BACFhF,GADL,IAEEoC,QAAQ,GAAD,mBACFpC,EAAIoC,SADF,CAEL,CACE1E,SACAC,QAAS0E,UAOnB,SAAS+C,EAAT,GAA0C,IAApB9G,EAAmB,EAAnBA,KAAMC,EAAa,EAAbA,GAAIF,EAAS,EAATA,MAC9BoG,EAAcnG,GAAM,SAAU0B,GAC5B,GAAKA,EAAL,CAGA,IAAMqF,EAAQ/C,EAAK/D,GACb6D,OAAoBhE,IAAVC,EAAsB2B,EAAIoC,QAAU,CAACpC,EAAIoC,QAAQ/D,IAIjE,OAHA+D,EAAQO,SAAQ,SAAUN,GACxBuC,IAAcS,EAAMjF,KAAMiC,EAAO1E,YAE5B,2BACFqC,GADL,IAEEoC,QAASpC,EAAIoC,QAAQG,QAAO,SAAUF,GACpC,OAAQD,EAAQkD,SAASjD,YAMjC,IAAMpB,EAAWrC,IAAoBU,EAErC,OACE,sBAAKvC,UAAU,MAAf,UACE,cAAC,EAAD,CACE4B,UAAWA,EACXC,gBAAiBA,EACjBE,yBAA0BA,EAC1BO,iBA9GN,SAA8BK,GAC5B2E,EAAmB3E,GACnB4E,EAA4B,GAC5BE,EAAQ,KA4GJ3E,WAzGN,WACEyE,EAA4BxF,EAA2B,GACvD,IAAMJ,EAAuBC,EAAUC,GACvC,cAA0BF,EAAqBI,GAA/C,GAAOpB,EAAP,KAAeC,EAAf,KACA,OAAQD,GACN,KAAKE,EACH+G,IACA,MACF,KAAK/G,EACHmH,EAAmBpH,GACnB,MACF,KAAKC,EACHwH,EAAWzH,GACX,MACF,KAAKC,EACHiH,EAAelH,GACf,MACF,QACE,MAAM,IAAIQ,MAAM,sBAAwBT,KAwFxCoC,cApFN,WACEwE,EAA4B,GAC5BE,EAAQ,KAmFJvH,UAAW0H,IAEb,qBAAK5H,UAAU,iBAAf,SACGuF,EAAKC,OAAOgD,SAAS9F,KAAI,SAAUO,GAClC,OACE,cAAC,EAAD,CAEEA,IAAKA,EACLsC,KAAMA,EACNrB,SAAUA,EACVhB,WAAY4E,EACZ/C,eAAgBiD,EAChB5C,OAAQiD,GANHpF,EAAIjC,YClJvByH,IAASC,OACP,cAAC,IAAMC,WAAP,UACE,cAAC,EAAD,MAEFC,SAASC,eAAe,W","file":"static/js/main.b2295627.chunk.js","sourcesContent":["/**\n * @since 2021-06-26\n * @author vivaxy\n */\nexport const CUSTOM_SCENARIO = 'CUSTOM_SCENARIO';\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport './Actions.css';\n\nexport default function Actions(props) {\n  return (\n    <div className=\"actions\">\n      <span>Actions: </span>\n      <button onClick={props.onOpenDoc}>Open a new doc</button>\n    </div>\n  );\n}\n","/**\n * @since 2021-06-24\n * @author vivaxy\n */\nexport const DOC_OPEN = 'DOC_OPEN';\nexport const DOC_UPDATE = 'DOC_UPDATE';\nexport const DOC_SYNC = 'DOC_SYNC';\nexport const DOC_CLOSE = 'DOC_CLOSE';\n","/**\n * @since 2021-06-24\n * @author vivaxy\n */\nexport const INSERT = 'INSERT';\nexport const DELETE = 'DELETE';\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as ENUMS from '../enums/enums';\nimport Actions from './Scenarios/Actions';\nimport * as E from '../enums/event-types';\nimport * as EDIT_TYPE from '../enums/edit-types';\n\nimport './Scenarios.css';\n\nfunction stringifyStep(step) {\n  const [action, payload] = step;\n  switch (action) {\n    case E.DOC_OPEN:\n      return action;\n    case E.DOC_UPDATE:\n      if (payload.type === EDIT_TYPE.INSERT) {\n        return `${action} Doc:${payload.id} type:${payload.type} pos:${payload.pos} str:${payload.str}`;\n      }\n      if (payload.type === EDIT_TYPE.DELETE) {\n        return `${action} Doc:${payload.id} type:${payload.type} pos:${payload.pos} len:${payload.len}`;\n      }\n      throw new Error('Unexpect edit type: ' + payload.type);\n    case E.DOC_SYNC:\n      if (payload.index === undefined) {\n        return `${action} FromDoc:${payload.from} ToDoc:${payload.to}`;\n      }\n      return `${action} FromDoc:${payload.from} ToDoc:${payload.to} updateIndex:${payload.index}`;\n    case E.DOC_CLOSE:\n      return action;\n    default:\n      throw new Error('Expected action: ' + action);\n  }\n}\n\nexport default function Scenarios(props) {\n  const SCENARIOS_ID = 'scenarios';\n\n  function handleChange(e) {\n    if (e.target.value !== props.currentScenario) {\n      props.onScenarioChange(e.target.value);\n    }\n  }\n\n  function handleClick() {\n    const currentScenarioSteps = props.scenarios[props.currentScenario];\n    if (props.currentScenarioStepIndex < currentScenarioSteps.length) {\n      props.onNextStep();\n    } else {\n      props.onRestartStep();\n    }\n  }\n\n  function handleOpenDoc() {\n    props.onOpenDoc();\n  }\n\n  const currentScenarioSteps = props.scenarios[props.currentScenario];\n\n  const currentStep =\n    currentScenarioSteps &&\n    currentScenarioSteps[props.currentScenarioStepIndex - 1];\n\n  const nextStep =\n    currentScenarioSteps &&\n    currentScenarioSteps[props.currentScenarioStepIndex];\n\n  return (\n    <div className=\"scenarios\">\n      <label htmlFor={SCENARIOS_ID}>Scenarios: </label>\n      <select id={SCENARIOS_ID} onChange={handleChange}>\n        <option value={ENUMS.CUSTOM_SCENARIO}>Custom</option>\n        {Object.keys(props.scenarios).map(function (scenario) {\n          return (\n            <option key={scenario} value={scenario}>\n              {scenario}\n            </option>\n          );\n        })}\n      </select>\n      {currentScenarioSteps && (\n        <button\n          disabled={props.currentScenario === ENUMS.CUSTOM_SCENARIO}\n          onClick={handleClick}\n          className=\"next-step-button\"\n        >\n          {nextStep ? 'Next step' : 'Restart'}\n        </button>\n      )}\n      {nextStep && <span className=\"next-step\">{stringifyStep(nextStep)}</span>}\n      {currentStep && (\n        <p className=\"current-step\">\n          <span className=\"current-step-label\">Current step: </span>\n          <span>{stringifyStep(currentStep)}</span>\n        </p>\n      )}\n      {!currentScenarioSteps && <Actions onOpenDoc={handleOpenDoc} />}\n    </div>\n  );\n}\n","/**\n * @since 2021-06-26\n * @author vivaxy\n */\nimport './Tab.css';\n\nexport default function Tab(props) {\n  function handleCloseDoc() {\n    props.onCloseDoc(props.doc);\n  }\n\n  return (\n    <div className=\"doc-tab\">\n      <p className=\"doc-id\">Doc{props.doc.id}</p>\n      <button className=\"doc-close\" onClick={handleCloseDoc}>\n        x\n      </button>\n    </div>\n  )\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nexport const TEXT_KEY = 'sample-key';\n","/**\n * @since 2021-06-26\n * @author vivaxy\n */\nimport { useRef, useEffect } from 'react';\nimport * as EDIT_TYPES from '../../enums/edit-types';\nimport * as Y_DOC_KEYS from '../../enums/y-doc-keys';\nimport './Editor.css';\n\nfunction getChanges(prev, cur, cursorPos) {\n  if (cur.length > prev.length) {\n    return {\n      type: EDIT_TYPES.INSERT,\n      pos: cursorPos - cur.length + prev.length,\n      str: cur.slice(cursorPos - cur.length + prev.length, cursorPos),\n    };\n  }\n  if (cur.length < prev.length) {\n    return {\n      type: EDIT_TYPES.DELETE,\n      pos: cursorPos,\n      len: prev.length - cur.length,\n    };\n  }\n  throw new Error('Unexpected change');\n}\n\nfunction getTextFromYDoc(yDoc) {\n  return yDoc.getText(Y_DOC_KEYS.TEXT_KEY).toString();\n}\n\nexport default function Editor(props) {\n  const editorRef = useRef(null);\n  const editorValue = useRef(getTextFromYDoc(props.doc.yDoc));\n\n  function handleInput(e) {\n    const value = e.target.textContent;\n    if (editorValue.current !== value) {\n      const cursorPos = window.getSelection().getRangeAt(0).startOffset;\n      const change = getChanges(editorValue.current, value, cursorPos);\n      editorValue.current = value;\n      props.onEditorChange({\n        id: props.doc.id,\n        ...change,\n      });\n    }\n  }\n\n  useEffect(function () {\n    const text = getTextFromYDoc(props.doc.yDoc);\n    if (editorRef.current.textContent !== text) {\n      editorRef.current.textContent = text;\n    }\n    if (editorValue.current !== text) {\n      editorValue.current = text;\n    }\n  });\n\n  return (\n    <p\n      contentEditable={props.editable ? 'true' : 'false'}\n      className=\"editor\"\n      onInput={handleInput}\n      ref={editorRef}\n    />\n  );\n}\n","/**\n * @since 2021-06-26\n * @author vivaxy\n */\nimport * as EDIT_TYPES from '../../enums/edit-types';\nimport './Updates.css';\n\nfunction stringifyAction(action) {\n  return `${action.type} ${action.pos} ${action.str || action.len}`;\n}\n\nexport default function Updates(props) {\n  function createHandleSync(to, index) {\n    return function handleSync() {\n      props.onSync({ from: props.doc.id, to, index });\n    };\n  }\n\n  return (\n    <div className=\"updates\">\n      {props.doc.updates.map(function (update, index) {\n        return (\n          <p className=\"update\" key={index + stringifyAction(update.action)}>\n            <span\n              className={`update-detail${\n                update.action.type === EDIT_TYPES.INSERT ? ' insert' : ' delete'\n              }`}\n            >\n              {stringifyAction(update.action)}\n            </span>\n            {props.editable && props.docs\n              .filter(function (doc) {\n                return doc && doc.id !== props.doc.id;\n              })\n              .map(function (doc) {\n                return (\n                  <button\n                    className=\"sync-button\"\n                    key={doc.id}\n                    onClick={createHandleSync(doc.id, index)}\n                  >\n                    To Doc{doc.id}\n                  </button>\n                );\n              })}\n          </p>\n        );\n      })}\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport './YDocModel.css';\n\nfunction getSharedTypeId(sharedType) {\n  return `${sharedType.id.client} ${sharedType.id.clock}`;\n}\n\nfunction renderMissing(missing) {\n  const res = [];\n  missing.forEach(function (value, clientID) {\n    res.push(\n      <p key={clientID}>\n        <span className=\"client-id\">{clientID}:</span>\n        <span>{value}</span>\n      </p>,\n    );\n  });\n  return res;\n}\n\nfunction renderModel(sharedType, clientID) {\n  const sharedTypeNode = (\n    <div\n      className={`shared-type${sharedType.content.str ? ' insert' : ' delete'}${\n        sharedType.id.client === clientID ? ' current' : ' link'\n      }`}\n      key={getSharedTypeId(sharedType)}\n    >\n      <p className=\"clock\">{sharedType.id.clock}</p>\n      <p className=\"shared-type-value\">\n        {sharedType.content.str || sharedType.content.len}\n      </p>\n    </div>\n  );\n\n  if (sharedType.right) {\n    return [sharedTypeNode, ...renderModel(sharedType.right, clientID)];\n  }\n  return [sharedTypeNode];\n}\n\nexport default function YDocModel(props) {\n  const children = [];\n  props.yDoc.store.clients.forEach(function (items, clientID) {\n    children.push(\n      <div className=\"client\" key={clientID}>\n        <p className=\"client-id\">clientID: {clientID}</p>\n        <div className=\"client-model\">\n          {renderModel(items[0].parent._start, clientID)}\n        </div>\n      </div>,\n    );\n  });\n\n  return (\n    <div className=\"y-doc-model\">\n      {props.yDoc.store.pendingStructs && (\n        <div className=\"pending-structs\">\n          <p>missing:</p>\n          {renderMissing(props.yDoc.store.pendingStructs.missing)}\n        </div>\n      )}\n      <div className=\"clients\">{children}</div>\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport Tab from './Doc/Tab';\nimport Editor from './Doc/Editor';\nimport Updates from './Doc/Updates';\nimport YDocModel from './Doc/YDocModel';\nimport './Doc.css';\n\nexport default function Doc(props) {\n  return (\n    <div className=\"doc-container\">\n      <Tab doc={props.doc} onCloseDoc={props.onCloseDoc} />\n      <Editor\n        doc={props.doc}\n        onEditorChange={props.onEditorChange}\n        editable={props.editable}\n      />\n      <Updates\n        doc={props.doc}\n        docs={props.docs}\n        onSync={props.onSync}\n        editable={props.editable}\n      />\n      <YDocModel yDoc={props.doc.yDoc} />\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nexport default [\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      type: EDIT_TYPES.INSERT,\n      pos: 0,\n      str: 'FOO',\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      type: EDIT_TYPES.DELETE,\n      pos: 1,\n      len: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      type: EDIT_TYPES.INSERT,\n      pos: 1,\n      str: 'T',\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      type: EDIT_TYPES.INSERT,\n      pos: 1,\n      str: 'B',\n    },\n  ],\n];\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport DocEdit from './doc-edit';\nimport TwoDocsSyncWithoutConflicts from './two-docs-sync-without-conflicts.js';\nimport TwoDocsSyncWithConflicts from './two-docs-sync-with-conflicts.js';\nimport TwoDocsSyncWithLostUpdates from './two-docs-sync-with-lost-updates.js';\n\nexport default {\n  DocEdit,\n  TwoDocsSyncWithoutConflicts,\n  TwoDocsSyncWithConflicts,\n  TwoDocsSyncWithLostUpdates,\n};\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nexport default [\n  [E.DOC_OPEN],\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      type: EDIT_TYPES.INSERT,\n      pos: 0,\n      str: 'FOO',\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      type: EDIT_TYPES.DELETE,\n      pos: 1,\n      len: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      type: EDIT_TYPES.INSERT,\n      pos: 1,\n      str: 'T',\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 1,\n      to: 0,\n    },\n  ],\n];\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nexport default [\n  [E.DOC_OPEN],\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      type: EDIT_TYPES.INSERT,\n      pos: 0,\n      str: 'FOO',\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      type: EDIT_TYPES.INSERT,\n      pos: 3,\n      str: 'B',\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      type: EDIT_TYPES.INSERT,\n      pos: 3,\n      str: 'T',\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 1,\n      to: 0,\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n];\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nexport default [\n  [E.DOC_OPEN],\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      type: EDIT_TYPES.INSERT,\n      pos: 0,\n      str: 'FOO',\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      type: EDIT_TYPES.INSERT,\n      pos: 3,\n      str: 'B',\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      type: EDIT_TYPES.INSERT,\n      pos: 4,\n      str: 'AR',\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      type: EDIT_TYPES.INSERT,\n      pos: 3,\n      str: 'T',\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n      index: 1,\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 1,\n      to: 0,\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n      index: 0,\n    },\n  ],\n];\n","import { useState } from 'react';\nimport * as Y from 'yjs';\n\nimport Scenarios from './components/Scenarios';\nimport Doc from './components/Doc';\nimport scenarios from './scenarios';\nimport * as EDIT_TYPE from './enums/edit-types';\nimport * as Y_DOC_KEYS from './enums/y-doc-keys';\nimport * as E from './enums/event-types.js';\nimport * as ENUMS from './enums/enums';\n\nimport './App.css';\n\nexport default function App() {\n  const [currentScenario, setCurrentScenario] = useState(ENUMS.CUSTOM_SCENARIO);\n  const [currentScenarioStepIndex, setCurrentScenarioStepIndex] = useState(0);\n  const [docs, _setDocs] = useState([]);\n\n  function setDocs(docs) {\n    _setDocs(docs);\n    window.docs = docs;\n  }\n\n  function updateDocById(id, updateDoc) {\n    const newDocs = [\n      ...docs.slice(0, id),\n      updateDoc(docs[id]),\n      ...docs.slice(id + 1),\n    ];\n    setDocs(newDocs);\n  }\n\n  function handleScenarioChange(scenario) {\n    setCurrentScenario(scenario);\n    setCurrentScenarioStepIndex(0);\n    setDocs([]);\n  }\n\n  function handleNextStep() {\n    setCurrentScenarioStepIndex(currentScenarioStepIndex + 1);\n    const currentScenarioSteps = scenarios[currentScenario];\n    const [action, payload] = currentScenarioSteps[currentScenarioStepIndex];\n    switch (action) {\n      case E.DOC_OPEN:\n        handleOpenDoc();\n        break;\n      case E.DOC_UPDATE:\n        handleEditorChange(payload);\n        break;\n      case E.DOC_SYNC:\n        handleSync(payload);\n        break;\n      case E.DOC_CLOSE:\n        handleCloseDoc(payload);\n        break;\n      default:\n        throw new Error('Unexpected action: ' + action);\n    }\n  }\n\n  function handleRestartStep() {\n    setCurrentScenarioStepIndex(0);\n    setDocs([]);\n  }\n\n  function handleOpenDoc() {\n    const yDoc = new Y.Doc();\n    setDocs([\n      ...docs,\n      {\n        id: docs.length,\n        yDoc: yDoc, // mutable\n        updates: [], // { action, payload }\n      },\n    ]);\n  }\n\n  function handleCloseDoc(doc) {\n    doc.yDoc.destroy();\n    updateDocById(doc.id, function () {\n      return null;\n    });\n  }\n\n  function handleEditorChange(action) {\n    const { id, type, pos, str, len } = action;\n    updateDocById(id, function (doc) {\n      const prevStateVector = Y.encodeStateVector(doc.yDoc);\n      const yText = doc.yDoc.getText(Y_DOC_KEYS.TEXT_KEY);\n      switch (type) {\n        case EDIT_TYPE.INSERT:\n          yText.insert(pos, str);\n          break;\n        case EDIT_TYPE.DELETE:\n          yText.delete(pos, len);\n          break;\n        default:\n          throw new Error('Unexpected type');\n      }\n\n      const update = Y.encodeStateAsUpdate(doc.yDoc, prevStateVector);\n\n      return {\n        ...doc,\n        updates: [\n          ...doc.updates,\n          {\n            action,\n            payload: update,\n          },\n        ],\n      };\n    });\n  }\n\n  function handleSync({ from, to, index }) {\n    updateDocById(from, function (doc) {\n      if (!doc) {\n        return;\n      }\n      const toDoc = docs[to];\n      const updates = index === undefined ? doc.updates : [doc.updates[index]];\n      updates.forEach(function (update) {\n        Y.applyUpdate(toDoc.yDoc, update.payload);\n      });\n      return {\n        ...doc,\n        updates: doc.updates.filter(function (update) {\n          return !updates.includes(update);\n        }),\n      };\n    });\n  }\n\n  const editable = currentScenario === ENUMS.CUSTOM_SCENARIO;\n\n  return (\n    <div className=\"App\">\n      <Scenarios\n        scenarios={scenarios}\n        currentScenario={currentScenario}\n        currentScenarioStepIndex={currentScenarioStepIndex}\n        onScenarioChange={handleScenarioChange}\n        onNextStep={handleNextStep}\n        onRestartStep={handleRestartStep}\n        onOpenDoc={handleOpenDoc}\n      />\n      <div className=\"docs-container\">\n        {docs.filter(Boolean).map(function (doc) {\n          return (\n            <Doc\n              key={doc.id}\n              doc={doc}\n              docs={docs}\n              editable={editable}\n              onCloseDoc={handleCloseDoc}\n              onEditorChange={handleEditorChange}\n              onSync={handleSync}\n            />\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root'),\n);\n"],"sourceRoot":""}