{"version":3,"sources":["enums/enums.js","components/Scenarios/Actions.js","enums/event-types.js","enums/edit-types.js","components/Scenarios.js","components/Doc/Tab.js","enums/y-doc-keys.js","components/Doc/Editor.js","components/Doc/Updates.js","components/Doc/YDocModel.js","components/Doc.js","scenarios/doc-edit.js","scenarios/index.js","scenarios/two-docs-sync-without-conflicts.js","scenarios/two-docs-sync-with-conflicts.js","scenarios/two-docs-sync-with-lost-updates.js","helpers.js","App.js","index.js"],"names":["CUSTOM_SCENARIO","Actions","props","className","onClick","onOpenDoc","DOC_OPEN","DOC_UPDATE","DOC_SYNC","DOC_CLOSE","INSERT","DELETE","stringifyStep","step","event","payload","E","id","actions","map","action","type","EDIT_TYPE","pos","str","len","Error","join","undefined","index","from","to","Scenarios","SCENARIOS_ID","currentScenarioSteps","scenarios","currentScenario","currentStep","currentScenarioStepIndex","nextStep","htmlFor","onChange","e","target","value","onScenarioChange","ENUMS","Object","keys","scenario","disabled","length","onNextStep","onRestartStep","Tab","doc","onCloseDoc","TEXT_KEY","getActions","prev","cur","cursorPos","diffStart","max","Math","min","i","getDiffStart","diffEnd","getDiffEnd","EDIT_TYPES","slice","getActionByLengthChange","deleted","inserted","push","getTextFromYDoc","yDoc","getText","Y_DOC_KEYS","toString","Editor","editorRef","useRef","editorValue","useEffect","text","current","textContent","contentEditable","editable","onInput","window","getSelection","getRangeAt","startOffset","onEditorChange","ref","stringifyAction","Updates","createHandleSync","onSync","updates","update","docs","filter","renderMissing","missing","res","forEach","clientID","renderTextModel","item","content","client","clock","sharedType","right","renderDeleteSet","currentClientID","children","pud","Y","dss","ds","userDescription","clients","get","deleteItems","deleteItem","YDocModel","store","_","_start","pendingStructs","Doc","DocEdit","TwoDocsSyncWithoutConflicts","TwoDocsSyncWithConflicts","TwoDocsSyncWithLostUpdates","sleep","timeout","Promise","resolve","setTimeout","App","key","useState","URL","location","href","searchParams","setCurrentScenario","setCurrentScenarioStepIndex","_setDocs","setDocs","updateDocById","updateDoc","a","handleOpenDoc","handleEditorChange","handleSync","handleCloseDoc","_prevStateVector","setUserMapping","destroy","change","newUpdates","yText","insert","delete","toDoc","includes","Boolean","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"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EAAMwF,WAElB,cAAC,EAAD,CACEnC,IAAKrD,EAAMqD,IACXiD,KAAMtG,EAAMsG,KACZH,OAAQnG,EAAMmG,OACdX,SAAUxF,EAAMwF,WAElB,cAAC,EAAD,CAAWb,KAAM3E,EAAMqD,IAAIsB,UClBjC,ICSe1C,EAPG,CAChBqG,QDHc,CACd,CAACxH,GACD,CACEA,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMiD,EACN/C,IAAK,EACLC,IAAK,UAKb,CACER,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMiD,EACN/C,IAAK,EACLE,IAAK,MAKb,CACET,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMiD,EACN/C,IAAK,EACLC,IAAK,QAKb,CACER,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMiD,EACN/C,IAAK,EACLC,IAAK,SC7CbiH,4BCJkC,CAClC,CAACzH,GACD,CAACA,GACD,CACEA,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMiD,EACN/C,IAAK,EACLC,IAAK,UAKb,CACER,EACA,CACEc,KAAM,EACNC,GAAI,IAGR,CACEf,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMiD,EACN/C,IAAK,EACLE,IAAK,MAKb,CACET,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMiD,EACN/C,IAAK,EACLC,IAAK,QAKb,CACER,EACA,CACEc,KAAM,EACNC,GAAI,KDhDR2G,yBEL+B,CAC/B,CAAC1H,GACD,CAACA,GACD,CACEA,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMiD,EACN/C,IAAK,EACLC,IAAK,UAKb,CACER,EACA,CACEc,KAAM,EACNC,GAAI,IAGR,CACEf,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMiD,EACN/C,IAAK,EACLC,IAAK,QAKb,CACER,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMiD,EACN/C,IAAK,EACLC,IAAK,QAKb,CACER,EACA,CACEc,KAAM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","file":"static/js/main.0cb5db91.chunk.js","sourcesContent":["/**\n * @since 2021-06-26\n * @author vivaxy\n */\nexport const CUSTOM_SCENARIO = 'CUSTOM_SCENARIO';\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport './Actions.css';\n\nexport default function Actions(props) {\n  return (\n    <div className=\"actions\">\n      <span>Actions: </span>\n      <button onClick={props.onOpenDoc}>Open a new doc</button>\n    </div>\n  );\n}\n","/**\n * @since 2021-06-24\n * @author vivaxy\n */\nexport const DOC_OPEN = 'DOC_OPEN';\nexport const DOC_UPDATE = 'DOC_UPDATE';\nexport const DOC_SYNC = 'DOC_SYNC';\nexport const DOC_CLOSE = 'DOC_CLOSE';\n","/**\n * @since 2021-06-24\n * @author vivaxy\n */\nexport const INSERT = 'INSERT';\nexport const DELETE = 'DELETE';\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as ENUMS from '../enums/enums';\nimport Actions from './Scenarios/Actions';\nimport * as E from '../enums/event-types';\nimport * as EDIT_TYPE from '../enums/edit-types';\n\nimport './Scenarios.css';\n\nfunction stringifyStep(step) {\n  const [event, payload] = step;\n  switch (event) {\n    case E.DOC_OPEN:\n      return event;\n    case E.DOC_UPDATE:\n      const { id, actions } = payload;\n      return actions\n        .map(function (action) {\n          if (action.type === EDIT_TYPE.INSERT) {\n            return `${event} Doc:${id} type:${action.type} pos:${action.pos} str:${action.str}`;\n          }\n          if (action.type === EDIT_TYPE.DELETE) {\n            return `${event} Doc:${id} type:${action.type} pos:${action.pos} len:${action.len}`;\n          }\n          throw new Error('Unexpect edit type: ' + action.type);\n        })\n        .join(' ; ');\n    case E.DOC_SYNC:\n      if (payload.index === undefined) {\n        return `${event} FromDoc:${payload.from} ToDoc:${payload.to}`;\n      }\n      return `${event} FromDoc:${payload.from} ToDoc:${payload.to} updateIndex:${payload.index}`;\n    case E.DOC_CLOSE:\n      return event;\n    default:\n      throw new Error('Expected action: ' + event);\n  }\n}\n\nexport default function Scenarios(props) {\n  const SCENARIOS_ID = 'scenarios';\n\n  function handleChange(e) {\n    if (e.target.value !== props.currentScenario) {\n      props.onScenarioChange(e.target.value);\n    }\n  }\n\n  function handleClick() {\n    const currentScenarioSteps = props.scenarios[props.currentScenario];\n    if (props.currentScenarioStepIndex < currentScenarioSteps.length) {\n      props.onNextStep();\n    } else {\n      props.onRestartStep();\n    }\n  }\n\n  function handleOpenDoc() {\n    props.onOpenDoc();\n  }\n\n  const currentScenarioSteps = props.scenarios[props.currentScenario];\n\n  const currentStep =\n    currentScenarioSteps &&\n    currentScenarioSteps[props.currentScenarioStepIndex - 1];\n\n  const nextStep =\n    currentScenarioSteps &&\n    currentScenarioSteps[props.currentScenarioStepIndex];\n\n  return (\n    <div className=\"scenarios\">\n      <label htmlFor={SCENARIOS_ID}>Scenarios: </label>\n      <select id={SCENARIOS_ID} onChange={handleChange}>\n        <option value={ENUMS.CUSTOM_SCENARIO}>Custom</option>\n        {Object.keys(props.scenarios).map(function (scenario) {\n          return (\n            <option key={scenario} value={scenario}>\n              {scenario}\n            </option>\n          );\n        })}\n      </select>\n      {currentScenarioSteps && (\n        <button\n          disabled={props.currentScenario === ENUMS.CUSTOM_SCENARIO}\n          onClick={handleClick}\n          className=\"next-step-button\"\n        >\n          {nextStep ? 'Next step' : 'Restart'}\n        </button>\n      )}\n      {nextStep && <span className=\"next-step\">{stringifyStep(nextStep)}</span>}\n      {currentStep && (\n        <p className=\"current-step\">\n          <span className=\"current-step-label\">Current step: </span>\n          <span>{stringifyStep(currentStep)}</span>\n        </p>\n      )}\n      {!currentScenarioSteps && <Actions onOpenDoc={handleOpenDoc} />}\n    </div>\n  );\n}\n","/**\n * @since 2021-06-26\n * @author vivaxy\n */\nimport './Tab.css';\n\nexport default function Tab(props) {\n  function handleCloseDoc() {\n    props.onCloseDoc(props.doc);\n  }\n\n  return (\n    <div className=\"doc-tab\">\n      <p className=\"doc-id\">Doc{props.doc.id}</p>\n      <button className=\"doc-close\" onClick={handleCloseDoc}>\n        x\n      </button>\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nexport const TEXT_KEY = 'sample-key';\n","/**\n * @since 2021-06-26\n * @author vivaxy\n */\nimport { useRef, useEffect } from 'react';\nimport * as EDIT_TYPES from '../../enums/edit-types';\nimport * as Y_DOC_KEYS from '../../enums/y-doc-keys';\nimport './Editor.css';\n\nfunction getDiffStart(prev, cur, cursorPos) {\n  const max = Math.min(\n    Math.max(prev.length - 1, 0),\n    Math.max(cur.length - 1, 0),\n    cursorPos,\n  );\n  for (let i = 0; i <= max; i++) {\n    if (prev[i] !== cur[i]) {\n      return i;\n    }\n  }\n  if (prev.length === 0 || cur.length === 0) {\n    return 0;\n  }\n  return max + 1;\n}\n\nfunction getDiffEnd(prev, cur, cursorPos) {\n  const max = Math.min(\n    Math.max(prev.length - 1, 0),\n    Math.max(cur.length - cursorPos, 0),\n  );\n  for (let i = 0; i <= max; i++) {\n    if (prev[prev.length - 1 - i] !== cur[cur.length - 1 - i]) {\n      return i;\n    }\n  }\n  return max;\n}\n\nfunction getActionByLengthChange(prev, cur, cursorPos) {\n  if (prev.length > cur.length) {\n    // delete\n    return {\n      type: EDIT_TYPES.DELETE,\n      pos: cursorPos,\n      len: prev.length - cur.length,\n    };\n  }\n  if (prev.length < cur.length) {\n    // insert\n    const pos = cursorPos - (cur.length - prev.length);\n    return {\n      type: EDIT_TYPES.INSERT,\n      pos,\n      str: cur.slice(pos, cursorPos),\n    };\n  }\n  return null;\n}\n\nfunction getActions(prev, cur, cursorPos) {\n  // 1. text before cursor is added\n  // 2. text after cursor or text before cursor is deleted\n  // 3. ignore changes that result in original text\n  const diffStart = getDiffStart(prev, cur, cursorPos);\n  const diffEnd = getDiffEnd(prev, cur, cursorPos);\n\n  if (\n    diffStart + diffEnd > prev.length - 1 ||\n    diffStart + diffEnd > cur.length - 1\n  ) {\n    // diff collapse\n    // possible same char\n    const action = getActionByLengthChange(prev, cur, cursorPos);\n    if (action) {\n      return [action];\n    }\n    return [];\n  }\n\n  const deleted = {\n    pos: diffStart,\n    len: prev.length - diffEnd - diffStart,\n  };\n  const inserted = {\n    pos: diffStart,\n    str: cur.slice(diffStart, cur.length - diffEnd),\n  };\n  const actions = [];\n  if (deleted.len) {\n    actions.push({\n      type: EDIT_TYPES.DELETE,\n      pos: deleted.pos,\n      len: deleted.len,\n    });\n  }\n  if (inserted.str.length) {\n    actions.push({\n      type: EDIT_TYPES.INSERT,\n      pos: inserted.pos,\n      str: inserted.str,\n    });\n  }\n  return actions;\n}\n\nfunction getTextFromYDoc(yDoc) {\n  return yDoc.getText(Y_DOC_KEYS.TEXT_KEY).toString();\n}\n\nexport default function Editor(props) {\n  const editorRef = useRef(null);\n  const editorValue = useRef(getTextFromYDoc(props.doc.yDoc));\n\n  function handleInput(e) {\n    const value = e.target.textContent;\n    if (editorValue.current !== value) {\n      const cursorPos = window.getSelection().getRangeAt(0).startOffset;\n      const actions = getActions(editorValue.current, value, cursorPos);\n      if (actions.length) {\n        editorValue.current = value;\n        props.onEditorChange({\n          id: props.doc.id,\n          actions,\n        });\n      }\n    }\n  }\n\n  useEffect(function () {\n    const text = getTextFromYDoc(props.doc.yDoc);\n    if (editorRef.current.textContent !== text) {\n      editorRef.current.textContent = text;\n    }\n    if (editorValue.current !== text) {\n      editorValue.current = text;\n    }\n  });\n\n  return (\n    <p\n      contentEditable={props.editable ? 'true' : 'false'}\n      className=\"editor\"\n      onInput={handleInput}\n      ref={editorRef}\n    />\n  );\n}\n","/**\n * @since 2021-06-26\n * @author vivaxy\n */\nimport * as EDIT_TYPES from '../../enums/edit-types';\nimport './Updates.css';\n\nfunction stringifyAction(action) {\n  return `${action.type} ${action.pos} ${action.str || action.len}`;\n}\n\nexport default function Updates(props) {\n  function createHandleSync(to, index) {\n    return function handleSync() {\n      props.onSync({ from: props.doc.id, to, index });\n    };\n  }\n\n  return (\n    <div className=\"updates\">\n      {props.doc.updates.map(function (update, index) {\n        return (\n          <p className=\"update\" key={index + stringifyAction(update.action)}>\n            <span\n              className={`update-detail${\n                update.action.type === EDIT_TYPES.INSERT ? ' insert' : ' delete'\n              }`}\n            >\n              {stringifyAction(update.action)}\n            </span>\n            {props.editable &&\n              props.docs\n                .filter(function (doc) {\n                  return doc && doc.id !== props.doc.id;\n                })\n                .map(function (doc) {\n                  return (\n                    <button\n                      className=\"sync-button\"\n                      key={doc.id}\n                      onClick={createHandleSync(doc.id, index)}\n                    >\n                      To Doc{doc.id}\n                    </button>\n                  );\n                })}\n          </p>\n        );\n      })}\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as Y from 'yjs';\nimport './YDocModel.css';\nimport { TEXT_KEY } from '../../enums/y-doc-keys';\n\nfunction getSharedTypeId(sharedType) {\n  return `${sharedType.id.client} ${sharedType.id.clock}`;\n}\n\nfunction renderMissing(missing) {\n  const res = [];\n  missing.forEach(function (value, clientID) {\n    res.push(\n      <p key={clientID}>\n        <span className=\"client-id\">{clientID}:</span>\n        <span>{value}</span>\n      </p>,\n    );\n  });\n  return res;\n}\n\nfunction renderTextModel(item, clientID) {\n  if (!item) {\n    return [];\n  }\n  const sharedTypeNode = (\n    <div\n      className={`item${item.content.str ? ' insert' : ' delete'}${\n        item.id.client === clientID ? ' current' : ' link'\n      }`}\n      key={getSharedTypeId(item)}\n    >\n      <p className=\"clock\">{item.id.clock}</p>\n      <p className=\"item-value\">{item.content.str || item.content.len}</p>\n    </div>\n  );\n\n  return [sharedTypeNode, ...renderTextModel(item.right, clientID)];\n}\n\nfunction renderDeleteSet(yDoc, currentClientID) {\n  const children = [];\n  const pud = new Y.PermanentUserData(yDoc);\n  pud.dss.forEach(function (ds, userDescription) {\n    const userDes = pud.clients.get(currentClientID);\n    if (userDes === userDescription) {\n      ds.clients.forEach(function (deleteItems, clientID) {\n        deleteItems.forEach(function (deleteItem) {\n          children.push(\n            <div\n              key={`${clientID}-${deleteItem.clock}`}\n              className=\"item delete\"\n            >\n              <p className=\"clock\">{deleteItem.clock}</p>\n              <p className=\"item-value\">{deleteItem.len}</p>\n            </div>,\n          );\n        });\n      });\n    }\n  });\n\n  return children;\n}\n\nexport default function YDocModel(props) {\n  const children = [];\n  props.yDoc.store.clients.forEach(function (_, clientID) {\n    children.push(\n      <div className=\"client\" key={clientID}>\n        <p className=\"client-id\">clientID: {clientID}</p>\n        <p className=\"label\">Text:</p>\n        <div className=\"client-text\">\n          {renderTextModel(props.yDoc.getText(TEXT_KEY)._start, clientID)}\n        </div>\n        <p className=\"label\">DeleteSet:</p>\n        <div className=\"pud\">{renderDeleteSet(props.yDoc, clientID)}</div>\n      </div>,\n    );\n  });\n\n  return (\n    <div className=\"y-doc-model\">\n      {props.yDoc.store.pendingStructs && (\n        <div className=\"pending-structs\">\n          <p>missing:</p>\n          {renderMissing(props.yDoc.store.pendingStructs.missing)}\n        </div>\n      )}\n      <div className=\"clients\">{children}</div>\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport Tab from './Doc/Tab';\nimport Editor from './Doc/Editor';\nimport Updates from './Doc/Updates';\nimport YDocModel from './Doc/YDocModel';\nimport './Doc.css';\n\nexport default function Doc(props) {\n  return (\n    <div className=\"doc-container\">\n      <Tab doc={props.doc} onCloseDoc={props.onCloseDoc} />\n      <Editor\n        doc={props.doc}\n        onEditorChange={props.onEditorChange}\n        editable={props.editable}\n      />\n      <Updates\n        doc={props.doc}\n        docs={props.docs}\n        onSync={props.onSync}\n        editable={props.editable}\n      />\n      <YDocModel yDoc={props.doc.yDoc} />\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nconst DocEdit = [\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 0,\n          str: 'FOO',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.DELETE,\n          pos: 1,\n          len: 1,\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 1,\n          str: 'T',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 1,\n          str: 'B',\n        },\n      ],\n    },\n  ],\n];\n\nexport default DocEdit;\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport DocEdit from './doc-edit';\nimport TwoDocsSyncWithoutConflicts from './two-docs-sync-without-conflicts.js';\nimport TwoDocsSyncWithConflicts from './two-docs-sync-with-conflicts.js';\nimport TwoDocsSyncWithLostUpdates from './two-docs-sync-with-lost-updates.js';\n\nconst scenarios = {\n  DocEdit,\n  TwoDocsSyncWithoutConflicts,\n  TwoDocsSyncWithConflicts,\n  TwoDocsSyncWithLostUpdates,\n};\n\nexport default scenarios;\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nconst TwoDocsSyncWithoutConflicts = [\n  [E.DOC_OPEN],\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 0,\n          str: 'FOO',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      actions: [\n        {\n          type: EDIT_TYPES.DELETE,\n          pos: 1,\n          len: 1,\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 1,\n          str: 'T',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 1,\n      to: 0,\n    },\n  ],\n];\n\nexport default TwoDocsSyncWithoutConflicts;\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nconst TwoDocsSyncWithConflicts = [\n  [E.DOC_OPEN],\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 0,\n          str: 'FOO',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 3,\n          str: 'B',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 3,\n          str: 'T',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 1,\n      to: 0,\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n];\n\nexport default TwoDocsSyncWithConflicts;\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nconst TwoDocsSyncWithLostUpdates = [\n  [E.DOC_OPEN],\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 0,\n          str: 'FOO',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 3,\n          str: 'B',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 4,\n          str: 'AR',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 3,\n          str: 'T',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n      index: 1,\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 1,\n      to: 0,\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n      index: 0,\n    },\n  ],\n];\n\nexport default TwoDocsSyncWithLostUpdates;\n","/**\n * @since 2021-07-08\n * @author vivaxy\n */\nexport function sleep(timeout) {\n  return new Promise(function (resolve) {\n    setTimeout(resolve, timeout);\n  });\n}\n","import { useState } from 'react';\nimport * as Y from 'yjs';\n\nimport Scenarios from './components/Scenarios';\nimport Doc from './components/Doc';\nimport scenarios from './scenarios';\nimport * as EDIT_TYPE from './enums/edit-types';\nimport * as Y_DOC_KEYS from './enums/y-doc-keys';\nimport * as E from './enums/event-types.js';\nimport * as ENUMS from './enums/enums';\nimport { sleep } from './helpers';\n\nimport './App.css';\n\nconst SCENARIO_QUERY_KEY = 'scenario';\n\nfunction getURLQuery(key) {\n  const url = new URL(window.location.href);\n  const searchParams = url.searchParams;\n  return searchParams.get(key);\n}\n\nexport default function App() {\n  // url like ?scenario=TwoDocsSyncWithoutConflicts\n  const [currentScenario, setCurrentScenario] = useState(\n    getURLQuery(SCENARIO_QUERY_KEY) || ENUMS.CUSTOM_SCENARIO,\n  );\n  const [currentScenarioStepIndex, setCurrentScenarioStepIndex] = useState(0);\n  const [docs, _setDocs] = useState([]);\n\n  function setDocs(docs) {\n    _setDocs(docs);\n    window.docs = docs;\n  }\n\n  async function updateDocById(id, updateDoc) {\n    const newDocs = [\n      ...docs.slice(0, id),\n      await updateDoc(docs[id]),\n      ...docs.slice(id + 1),\n    ];\n    setDocs(newDocs);\n  }\n\n  function handleScenarioChange(scenario) {\n    setCurrentScenario(scenario);\n    setCurrentScenarioStepIndex(0);\n    setDocs([]);\n  }\n\n  async function handleNextStep() {\n    setCurrentScenarioStepIndex(currentScenarioStepIndex + 1);\n    const currentScenarioSteps = scenarios[currentScenario];\n    const [action, payload] = currentScenarioSteps[currentScenarioStepIndex];\n    switch (action) {\n      case E.DOC_OPEN:\n        handleOpenDoc();\n        break;\n      case E.DOC_UPDATE:\n        await handleEditorChange(payload);\n        break;\n      case E.DOC_SYNC:\n        await handleSync(payload);\n        break;\n      case E.DOC_CLOSE:\n        await handleCloseDoc(payload);\n        break;\n      default:\n        throw new Error('Unexpected action: ' + action);\n    }\n  }\n\n  function handleRestartStep() {\n    setCurrentScenarioStepIndex(0);\n    setDocs([]);\n  }\n\n  function handleOpenDoc() {\n    const yDoc = new Y.Doc();\n    const pud = new Y.PermanentUserData(yDoc);\n    yDoc._prevStateVector = Y.encodeStateVector(yDoc);\n    const id = docs.length;\n    // cannot put in one transaction\n    // setUserMapping comes from local but applyUpdate comes from remote\n    pud.setUserMapping(yDoc, yDoc.clientID, `Doc${id}`);\n    const update = Y.encodeStateAsUpdate(yDoc, yDoc._prevStateVector);\n    yDoc._prevStateVector = Y.encodeStateVector(yDoc);\n    if (id !== 0) {\n      Y.applyUpdate(yDoc, Y.encodeStateAsUpdate(docs[0].yDoc));\n    }\n    // sync to other docs\n    // setUserMapping use setTimeout to update pud\n    docs.forEach(function (doc) {\n      Y.applyUpdate(doc.yDoc, update);\n    });\n    setDocs([\n      ...docs,\n      {\n        id,\n        yDoc, // mutable\n        pud,\n        updates: [], // { action, payload }\n      },\n    ]);\n  }\n\n  async function handleCloseDoc(doc) {\n    doc.yDoc.destroy();\n    await updateDocById(doc.id, function () {\n      return null;\n    });\n  }\n\n  async function handleEditorChange(change) {\n    const { id, actions } = change;\n    await updateDocById(id, async function (doc) {\n      let newUpdates = [];\n      for (let i = 0; i < actions.length; i++) {\n        const action = actions[i];\n        const { type, pos, str, len } = action;\n        const yText = doc.yDoc.getText(Y_DOC_KEYS.TEXT_KEY);\n        switch (type) {\n          case EDIT_TYPE.INSERT:\n            yText.insert(pos, str);\n            break;\n          case EDIT_TYPE.DELETE:\n            yText.delete(pos, len);\n            break;\n          default:\n            throw new Error('Unexpected type');\n        }\n        await sleep(0);\n        const update = Y.encodeStateAsUpdate(\n          doc.yDoc,\n          doc.yDoc._prevStateVector,\n        );\n        doc._prevStateVector = Y.encodeStateVector(doc.yDoc);\n        newUpdates.push({\n          action,\n          payload: update,\n        });\n      }\n      if (docs.length === 1) {\n        // do not record updates when there is only one doc.\n        return doc;\n      }\n      return {\n        ...doc,\n        updates: [...doc.updates, ...newUpdates],\n      };\n    });\n  }\n\n  async function handleSync({ from, to, index }) {\n    await updateDocById(from, function (doc) {\n      if (!doc) {\n        return;\n      }\n      const toDoc = docs[to];\n      const updates = index === undefined ? doc.updates : [doc.updates[index]];\n      updates.forEach(function (update) {\n        Y.applyUpdate(toDoc.yDoc, update.payload);\n      });\n      return {\n        ...doc,\n        updates: doc.updates.filter(function (update) {\n          return !updates.includes(update);\n        }),\n      };\n    });\n  }\n\n  const editable = currentScenario === ENUMS.CUSTOM_SCENARIO;\n\n  return (\n    <div className=\"App\">\n      <Scenarios\n        scenarios={scenarios}\n        currentScenario={currentScenario}\n        currentScenarioStepIndex={currentScenarioStepIndex}\n        onScenarioChange={handleScenarioChange}\n        onNextStep={handleNextStep}\n        onRestartStep={handleRestartStep}\n        onOpenDoc={handleOpenDoc}\n      />\n      <div className=\"docs-container\">\n        {docs.filter(Boolean).map(function (doc) {\n          return (\n            <Doc\n              key={doc.id}\n              doc={doc}\n              docs={docs}\n              editable={editable}\n              onCloseDoc={handleCloseDoc}\n              onEditorChange={handleEditorChange}\n              onSync={handleSync}\n            />\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n","/**\n * @author vivaxy\n * @since 2021-07-08\n *\n * @todo:\n *  - decode update\n */\n\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root'),\n);\n"],"sourceRoot":""}