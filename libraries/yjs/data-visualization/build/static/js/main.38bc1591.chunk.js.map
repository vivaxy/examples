{"version":3,"sources":["enums/enums.js","enums/event-types.js","enums/edit-types.js","components/Scenarios.js","components/Doc/Tab.js","enums/y-doc-keys.js","components/Doc/Editor.js","components/Doc/Updates.js","components/Doc/YDocModel.js","components/Doc.js","components/Actions/Buttons.js","components/Actions/Options.js","components/Actions.js","scenarios/doc-edit.js","scenarios/index.js","scenarios/two-docs-sync-without-conflicts.js","scenarios/two-docs-sync-with-conflicts.js","scenarios/two-docs-sync-with-lost-updates.js","helpers.js","update-decoder/type-decoder.js","update-decoder/content-decoder.js","update-decoder/delete-set-decoder.js","update-decoder/index.js","App.js","index.js"],"names":["CUSTOM_SCENARIO","DOC_OPEN","DOC_UPDATE","DOC_SYNC","DOC_CLOSE","INSERT","DELETE","stringifyStep","step","event","payload","E","id","actions","map","action","type","EDIT_TYPE","pos","str","len","Error","join","undefined","index","from","to","Scenarios","props","SCENARIOS_ID","currentScenarioSteps","scenarios","currentScenario","currentStep","currentScenarioStepIndex","nextStep","className","htmlFor","onChange","e","target","value","onScenarioChange","ENUMS","Object","keys","scenario","disabled","onClick","length","onNextStep","onRestartStep","Tab","doc","editable","onCloseDoc","TEXT_KEY","getActions","prev","cur","cursorPos","diffStart","max","Math","min","i","getDiffStart","diffEnd","getDiffEnd","EDIT_TYPES","slice","getActionByLengthChange","deleted","inserted","push","getTextFromYDoc","yDoc","getText","Y_DOC_KEYS","toString","Editor","editorRef","useRef","editorValue","useEffect","text","current","textContent","contentEditable","onInput","window","getSelection","getRangeAt","startOffset","onEditorChange","ref","stringifyAction","Updates","createHandleSync","onSync","updates","update","docs","filter","syncedIds","includes","renderMissing","missing","res","forEach","clientID","renderTextModel","struct","sharedType","formattedStruct","commonData","client","clock","content","Y","formatStruct","right","renderDeleteSet","currentClientID","children","pud","dss","ds","userDescription","clients","get","deleteItems","deleteItem","YDocModel","store","_","_start","pendingStructs","Doc","Buttons","onOpenDoc","IDS","DEFAULT_GET_VALUE","Options","createHandleChange","key","getValue","onOptionChange","checked","options","gc","Actions","DocEdit","TwoDocsSyncWithoutConflicts","TwoDocsSyncWithConflicts","TwoDocsSyncWithLostUpdates","sleep","timeout","Promise","resolve","setTimeout","typeDecoder","decoder","decoding","contentDecoder","error","c","JSON","parse","string","typeRefs","con","readDeleteSet","numClients","numberOfDeletes","decode","clientData","clientRefs","numOfStateUpdates","totalLength","numberOfStructs","items","readID","info","binary","readItem","Item","readClientsStructRefs","deleteSet","left","origin","rightOrigin","parentYKey","parent","this","canCopyParentInfo","hasParentYKey","itemContent","contentRefs","readItemContent","App","useState","URL","location","href","searchParams","setCurrentScenario","setCurrentScenarioStepIndex","_setDocs","setOptions","setDocs","updateDocById","updateDoc","a","handleOpenDoc","handleEditorChange","handleSync","handleCloseDoc","setUserMapping","validDocs","Boolean","destroy","change","newUpdates","prevStateVector","yText","insert","delete","decodedUpdate","decodeUpdate","item","decodeDeleteSet","decodedContent","console","log","toDoc","toSyncUpdates","changedOption","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"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,CAAC7I,GACD,CACEA,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLC,IAAK,UAKb,CACER,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLE,IAAK,MAKb,CACET,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLC,IAAK,QAKb,CACER,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLC,IAAK,SC7CbsI,4BCJkC,CAClC,CAAC9I,GACD,CAACA,GACD,CACEA,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLC,IAAK,UAKb,CACER,EACA,CACEc,KAAM,EACNC,GAAI,IAGR,CACEf,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLE,IAAK,MAKb,CACET,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLC,IAAK,QAKb,CACER,EACA,CACEc,KAAM,EACNC,GAAI,KDhDRgI,yBEL+B,CAC/B,CAAC/I,GACD,CAACA,GACD,CACEA,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLC,IAAK,UAKb,CACER,EACA,CACEc,KAAM,EACNC,GAAI,IAGR,CACEf,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLC,IAAK,QAKb,CACER,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLC,IAAK,QAKb,CACER,EACA,CACEc,KAAM,EACNC,GAAI,IAGR,CACEf,EACA,CACEc,KAAM,EACNC,GAAI,KFtDRiI,2BGNiC,CACjC,CAAChJ,GACD,CAACA,GACD,CACEA,EACA,CACEC,GAAI,EACJC,QAAS,CACP,CACEG,KAAMqD,EACNnD,IAAK,EACLC,IAAK,UAKb,CACER,EACA,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","file":"static/js/main.38bc1591.chunk.js","sourcesContent":["/**\n * @since 2021-06-26\n * @author vivaxy\n */\nexport const CUSTOM_SCENARIO = 'CUSTOM_SCENARIO';\n","/**\n * @since 2021-06-24\n * @author vivaxy\n */\nexport const DOC_OPEN = 'DOC_OPEN';\nexport const DOC_UPDATE = 'DOC_UPDATE';\nexport const DOC_SYNC = 'DOC_SYNC';\nexport const DOC_CLOSE = 'DOC_CLOSE';\n","/**\n * @since 2021-06-24\n * @author vivaxy\n */\nexport const INSERT = 'INSERT';\nexport const DELETE = 'DELETE';\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as ENUMS from '../enums/enums';\nimport * as E from '../enums/event-types';\nimport * as EDIT_TYPE from '../enums/edit-types';\n\nimport './Scenarios.css';\n\nfunction stringifyStep(step) {\n  const [event, payload] = step;\n  switch (event) {\n    case E.DOC_OPEN:\n      return event;\n    case E.DOC_UPDATE:\n      const { id, actions } = payload;\n      return actions\n        .map(function (action) {\n          if (action.type === EDIT_TYPE.INSERT) {\n            return `${event} Doc:${id} type:${action.type} pos:${action.pos} str:${action.str}`;\n          }\n          if (action.type === EDIT_TYPE.DELETE) {\n            return `${event} Doc:${id} type:${action.type} pos:${action.pos} len:${action.len}`;\n          }\n          throw new Error('Unexpect edit type: ' + action.type);\n        })\n        .join(' ; ');\n    case E.DOC_SYNC:\n      if (payload.index === undefined) {\n        return `${event} FromDoc:${payload.from} ToDoc:${payload.to}`;\n      }\n      return `${event} FromDoc:${payload.from} ToDoc:${payload.to} updateIndex:${payload.index}`;\n    case E.DOC_CLOSE:\n      return event;\n    default:\n      throw new Error('Expected action: ' + event);\n  }\n}\n\nexport default function Scenarios(props) {\n  const SCENARIOS_ID = 'scenarios';\n\n  function handleChange(e) {\n    if (e.target.value !== props.currentScenario) {\n      props.onScenarioChange(e.target.value);\n    }\n  }\n\n  function handleClick() {\n    const currentScenarioSteps = props.scenarios[props.currentScenario];\n    if (props.currentScenarioStepIndex < currentScenarioSteps.length) {\n      props.onNextStep();\n    } else {\n      props.onRestartStep();\n    }\n  }\n\n  const currentScenarioSteps = props.scenarios[props.currentScenario];\n\n  const currentStep =\n    currentScenarioSteps &&\n    currentScenarioSteps[props.currentScenarioStepIndex - 1];\n\n  const nextStep =\n    currentScenarioSteps &&\n    currentScenarioSteps[props.currentScenarioStepIndex];\n\n  return (\n    <div className=\"scenarios\">\n      <label htmlFor={SCENARIOS_ID}>Scenarios: </label>\n      <select id={SCENARIOS_ID} onChange={handleChange}>\n        <option value={ENUMS.CUSTOM_SCENARIO}>Custom</option>\n        {Object.keys(props.scenarios).map(function (scenario) {\n          return (\n            <option key={scenario} value={scenario}>\n              {scenario}\n            </option>\n          );\n        })}\n      </select>\n      {currentScenarioSteps && (\n        <button\n          disabled={props.currentScenario === ENUMS.CUSTOM_SCENARIO}\n          onClick={handleClick}\n          className=\"next-step-button\"\n        >\n          {nextStep ? 'Next step' : 'Restart'}\n        </button>\n      )}\n      {nextStep && <span className=\"next-step\">{stringifyStep(nextStep)}</span>}\n      {currentStep && (\n        <p className=\"current-step\">\n          <span className=\"current-step-label\">Current step: </span>\n          <span>{stringifyStep(currentStep)}</span>\n        </p>\n      )}\n    </div>\n  );\n}\n","/**\n * @since 2021-06-26\n * @author vivaxy\n */\nimport './Tab.css';\n\nexport default function Tab(props) {\n  function handleCloseDoc() {\n    props.onCloseDoc(props.doc);\n  }\n\n  return (\n    <div className=\"doc-tab\">\n      <p className=\"doc-id\">Doc{props.doc.id}</p>\n      {props.editable && (\n        <button className=\"doc-close\" onClick={handleCloseDoc}>\n          x\n        </button>\n      )}\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nexport const TEXT_KEY = 'sample-key';\n","/**\n * @since 2021-06-26\n * @author vivaxy\n */\nimport { useRef, useEffect } from 'react';\nimport * as EDIT_TYPES from '../../enums/edit-types';\nimport * as Y_DOC_KEYS from '../../enums/y-doc-keys';\nimport './Editor.css';\n\nfunction getDiffStart(prev, cur, cursorPos) {\n  const max = Math.min(\n    Math.max(prev.length - 1, 0),\n    Math.max(cur.length - 1, 0),\n    cursorPos,\n  );\n  for (let i = 0; i <= max; i++) {\n    if (prev[i] !== cur[i]) {\n      return i;\n    }\n  }\n  if (prev.length === 0 || cur.length === 0) {\n    return 0;\n  }\n  return max + 1;\n}\n\nfunction getDiffEnd(prev, cur, cursorPos) {\n  const max = Math.min(\n    Math.max(prev.length - 1, 0),\n    Math.max(cur.length - cursorPos, 0),\n  );\n  for (let i = 0; i <= max; i++) {\n    if (prev[prev.length - 1 - i] !== cur[cur.length - 1 - i]) {\n      return i;\n    }\n  }\n  return max;\n}\n\nfunction getActionByLengthChange(prev, cur, cursorPos) {\n  if (prev.length > cur.length) {\n    // delete\n    return {\n      type: EDIT_TYPES.DELETE,\n      pos: cursorPos,\n      len: prev.length - cur.length,\n    };\n  }\n  if (prev.length < cur.length) {\n    // insert\n    const pos = cursorPos - (cur.length - prev.length);\n    return {\n      type: EDIT_TYPES.INSERT,\n      pos,\n      str: cur.slice(pos, cursorPos),\n    };\n  }\n  return null;\n}\n\nfunction getActions(prev, cur, cursorPos) {\n  // 1. text before cursor is added\n  // 2. text after cursor or text before cursor is deleted\n  // 3. ignore changes that result in original text\n  const diffStart = getDiffStart(prev, cur, cursorPos);\n  const diffEnd = getDiffEnd(prev, cur, cursorPos);\n\n  if (\n    diffStart + diffEnd > prev.length - 1 ||\n    diffStart + diffEnd > cur.length - 1\n  ) {\n    // diff collapse\n    // possible same char\n    const action = getActionByLengthChange(prev, cur, cursorPos);\n    if (action) {\n      return [action];\n    }\n    return [];\n  }\n\n  const deleted = {\n    pos: diffStart,\n    len: prev.length - diffEnd - diffStart,\n  };\n  const inserted = {\n    pos: diffStart,\n    str: cur.slice(diffStart, cur.length - diffEnd),\n  };\n  const actions = [];\n  if (deleted.len) {\n    actions.push({\n      type: EDIT_TYPES.DELETE,\n      pos: deleted.pos,\n      len: deleted.len,\n    });\n  }\n  if (inserted.str.length) {\n    actions.push({\n      type: EDIT_TYPES.INSERT,\n      pos: inserted.pos,\n      str: inserted.str,\n    });\n  }\n  return actions;\n}\n\nfunction getTextFromYDoc(yDoc) {\n  return yDoc.getText(Y_DOC_KEYS.TEXT_KEY).toString();\n}\n\nexport default function Editor(props) {\n  const editorRef = useRef(null);\n  const editorValue = useRef(getTextFromYDoc(props.doc.yDoc));\n\n  function handleInput(e) {\n    const value = e.target.textContent;\n    if (editorValue.current !== value) {\n      const cursorPos = window.getSelection().getRangeAt(0).startOffset;\n      const actions = getActions(editorValue.current, value, cursorPos);\n      if (actions.length) {\n        editorValue.current = value;\n        props.onEditorChange({\n          id: props.doc.id,\n          actions,\n        });\n      }\n    }\n  }\n\n  useEffect(function () {\n    const text = getTextFromYDoc(props.doc.yDoc);\n    if (editorRef.current.textContent !== text) {\n      editorRef.current.textContent = text;\n    }\n    if (editorValue.current !== text) {\n      editorValue.current = text;\n    }\n  });\n\n  return (\n    <p\n      contentEditable={props.editable ? 'true' : 'false'}\n      className=\"editor\"\n      onInput={handleInput}\n      ref={editorRef}\n    />\n  );\n}\n","/**\n * @since 2021-06-26\n * @author vivaxy\n */\nimport * as EDIT_TYPES from '../../enums/edit-types';\nimport './Updates.css';\n\nfunction stringifyAction(action) {\n  return `${action.type} ${action.pos} ${action.str || action.len}`;\n}\n\nexport default function Updates(props) {\n  function createHandleSync(to, index) {\n    return function handleSync() {\n      props.onSync({ from: props.doc.id, to, index });\n    };\n  }\n\n  return (\n    <div className=\"updates\">\n      {props.doc.updates.map(function (update, index) {\n        return (\n          <p className=\"update\" key={index + stringifyAction(update.action)}>\n            <span\n              className={`update-detail${\n                update.action.type === EDIT_TYPES.INSERT ? ' insert' : ' delete'\n              }`}\n            >\n              {stringifyAction(update.action)}\n            </span>\n            {props.editable &&\n              props.docs\n                .filter(function (doc) {\n                  return doc && !update.syncedIds.includes(doc.id);\n                })\n                .map(function (doc) {\n                  return (\n                    <button\n                      className=\"sync-button\"\n                      key={doc.id}\n                      onClick={createHandleSync(doc.id, index)}\n                    >\n                      To Doc{doc.id}\n                    </button>\n                  );\n                })}\n          </p>\n        );\n      })}\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as Y from 'yjs';\nimport './YDocModel.css';\nimport { TEXT_KEY } from '../../enums/y-doc-keys';\n\nfunction getSharedTypeId(sharedType) {\n  return `${sharedType.id.client} ${sharedType.id.clock}`;\n}\n\nfunction renderMissing(missing) {\n  const res = [];\n  missing.forEach(function (value, clientID) {\n    res.push(\n      <p key={clientID}>\n        <span className=\"client-id\">{clientID}:</span>\n        <span>{value}</span>\n      </p>,\n    );\n  });\n  return res;\n}\n\nfunction formatStruct(struct) {\n  const commonData = {\n    client: struct.id.client,\n    clock: struct.id.clock,\n  };\n  if (struct.content instanceof Y.ContentDeleted) {\n    return {\n      ...commonData,\n      deleted: true,\n      len: struct.content.len,\n    };\n  }\n  if (struct.deleted) {\n    return {\n      ...commonData,\n      deleted: true,\n      content: struct.content.str,\n      len: struct.content.str.length,\n    };\n  }\n  return {\n    ...commonData,\n    deleted: false,\n    content: struct.content.str,\n  };\n}\n\nfunction renderTextModel(struct, clientID) {\n  if (!struct) {\n    return [];\n  }\n  const formattedStruct = formatStruct(struct);\n  const sharedTypeNode = (\n    <div\n      className={`item${formattedStruct.deleted ? ' delete' : ' insert'}${\n        formattedStruct.client === clientID ? ' current' : ' link'\n      }`}\n      key={getSharedTypeId(struct)}\n    >\n      <p className=\"clock\">{formattedStruct.clock}</p>\n      <p className=\"item-value\">\n        {formattedStruct.content || formattedStruct.len}\n      </p>\n    </div>\n  );\n\n  return [sharedTypeNode, ...renderTextModel(struct.right, clientID)];\n}\n\nfunction renderDeleteSet(yDoc, currentClientID) {\n  const children = [];\n  const pud = new Y.PermanentUserData(yDoc);\n  pud.dss.forEach(function (ds, userDescription) {\n    const userDes = pud.clients.get(currentClientID);\n    if (userDes === userDescription) {\n      ds.clients.forEach(function (deleteItems, clientID) {\n        deleteItems.forEach(function (deleteItem) {\n          children.push(\n            <div\n              key={`${clientID}-${deleteItem.clock}`}\n              className=\"item delete\"\n            >\n              <p className=\"clock\">{deleteItem.clock}</p>\n              <p className=\"item-value\">{deleteItem.len}</p>\n            </div>,\n          );\n        });\n      });\n    }\n  });\n\n  return children;\n}\n\nexport default function YDocModel(props) {\n  const children = [];\n  props.yDoc.store.clients.forEach(function (_, clientID) {\n    children.push(\n      <div className=\"client\" key={clientID}>\n        <p className=\"client-id\">clientID: {clientID}</p>\n        <p className=\"label\">Text:</p>\n        <div className=\"client-text\">\n          {renderTextModel(props.yDoc.getText(TEXT_KEY)._start, clientID)}\n        </div>\n        <p className=\"label\">DeleteSet:</p>\n        <div className=\"pud\">{renderDeleteSet(props.yDoc, clientID)}</div>\n      </div>,\n    );\n  });\n\n  return (\n    <div className=\"y-doc-model\">\n      {props.yDoc.store.pendingStructs && (\n        <div className=\"pending-structs\">\n          <p>missing:</p>\n          {renderMissing(props.yDoc.store.pendingStructs.missing)}\n        </div>\n      )}\n      <div className=\"clients\">{children}</div>\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport Tab from './Doc/Tab';\nimport Editor from './Doc/Editor';\nimport Updates from './Doc/Updates';\nimport YDocModel from './Doc/YDocModel';\nimport './Doc.css';\n\nexport default function Doc(props) {\n  return (\n    <div className=\"doc-container\">\n      <Tab\n        doc={props.doc}\n        onCloseDoc={props.onCloseDoc}\n        editable={props.editable}\n      />\n      <Editor\n        doc={props.doc}\n        onEditorChange={props.onEditorChange}\n        editable={props.editable}\n      />\n      <Updates\n        doc={props.doc}\n        docs={props.docs}\n        onSync={props.onSync}\n        editable={props.editable}\n      />\n      <YDocModel yDoc={props.doc.yDoc} />\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nexport default function Buttons(props) {\n  function handleOpenDoc() {\n    props.onOpenDoc();\n  }\n\n  return (\n    <span className=\"buttons-container\">\n      <span>Actions: </span>\n      <button onClick={handleOpenDoc}>Open a new doc</button>\n    </span>\n  );\n}\n","/**\n * @since 2021-07-16\n * @author vivaxy\n */\nimport './Options.css';\n\nconst IDS = {\n  GC: 'option-gc',\n  PUD: 'option-pud',\n};\n\nfunction DEFAULT_GET_VALUE(e) {\n  return e.target.value;\n}\n\nexport default function Options(props) {\n  function createHandleChange(key, getValue = DEFAULT_GET_VALUE) {\n    return function handleChange(e) {\n      props.onOptionChange({\n        [key]: getValue(e),\n      });\n    };\n  }\n\n  return (\n    <span className=\"options-container\">\n      <label htmlFor={IDS.GC}>GC:</label>\n      <input\n        id={IDS.GC}\n        type=\"checkbox\"\n        disabled={props.disabled}\n        checked={props.options.gc}\n        onChange={createHandleChange('gc', function (e) {\n          return e.target.checked;\n        })}\n      />\n      <label htmlFor={IDS.PUD}>PermanentUserData:</label>\n      <input\n        id={IDS.PUD}\n        type=\"checkbox\"\n        disabled={props.disabled}\n        checked={props.options.pud}\n        onChange={createHandleChange('pud', function (e) {\n          return e.target.checked;\n        })}\n      />\n    </span>\n  );\n}\n","/**\n * @since 2021-07-13\n * @author vivaxy\n */\nimport Buttons from './Actions/Buttons';\nimport Options from './Actions/Options';\n\nexport default function Actions(props) {\n  return (\n    <div className=\"actions-container\">\n      <Buttons onOpenDoc={props.onOpenDoc} />\n      <Options\n        disabled={props.disabled}\n        options={props.options}\n        onOptionChange={props.onOptionChange}\n      />\n    </div>\n  );\n}\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nconst DocEdit = [\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 0,\n          str: 'FOO',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.DELETE,\n          pos: 1,\n          len: 1,\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 1,\n          str: 'T',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 1,\n          str: 'B',\n        },\n      ],\n    },\n  ],\n];\n\nexport default DocEdit;\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport DocEdit from './doc-edit';\nimport TwoDocsSyncWithoutConflicts from './two-docs-sync-without-conflicts.js';\nimport TwoDocsSyncWithConflicts from './two-docs-sync-with-conflicts.js';\nimport TwoDocsSyncWithLostUpdates from './two-docs-sync-with-lost-updates.js';\n\nconst scenarios = {\n  DocEdit,\n  TwoDocsSyncWithoutConflicts,\n  TwoDocsSyncWithConflicts,\n  TwoDocsSyncWithLostUpdates,\n};\n\nexport default scenarios;\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nconst TwoDocsSyncWithoutConflicts = [\n  [E.DOC_OPEN],\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 0,\n          str: 'FOO',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      actions: [\n        {\n          type: EDIT_TYPES.DELETE,\n          pos: 1,\n          len: 1,\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 1,\n          str: 'T',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 1,\n      to: 0,\n    },\n  ],\n];\n\nexport default TwoDocsSyncWithoutConflicts;\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nconst TwoDocsSyncWithConflicts = [\n  [E.DOC_OPEN],\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 0,\n          str: 'FOO',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 3,\n          str: 'B',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 3,\n          str: 'T',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 1,\n      to: 0,\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n];\n\nexport default TwoDocsSyncWithConflicts;\n","/**\n * @since 2021-06-25\n * @author vivaxy\n */\nimport * as E from '../enums/event-types.js';\nimport * as EDIT_TYPES from '../enums/edit-types.js';\n\nconst TwoDocsSyncWithLostUpdates = [\n  [E.DOC_OPEN],\n  [E.DOC_OPEN],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 0,\n          str: 'FOO',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 3,\n          str: 'B',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 0,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 4,\n          str: 'AR',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_UPDATE,\n    {\n      id: 1,\n      actions: [\n        {\n          type: EDIT_TYPES.INSERT,\n          pos: 3,\n          str: 'T',\n        },\n      ],\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n      index: 1,\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 1,\n      to: 0,\n    },\n  ],\n  [\n    E.DOC_SYNC,\n    {\n      from: 0,\n      to: 1,\n      index: 0,\n    },\n  ],\n];\n\nexport default TwoDocsSyncWithLostUpdates;\n","/**\n * @since 2021-07-08\n * @author vivaxy\n */\nexport function sleep(timeout) {\n  return new Promise(function (resolve) {\n    setTimeout(resolve, timeout);\n  });\n}\n","/**\n * @since 2021-07-08\n * @author vivaxy\n */\nimport * as Y from 'yjs';\nimport * as decoding from 'lib0/decoding';\n\nconst readYArray = () => {\n  return new Y.Array();\n};\n\nconst readYMap = () => {\n  return new Y.Map();\n};\n\nconst readYText = () => {\n  return new Y.Text();\n};\n\nconst readYXmlElement = (decoder) => {\n  decoding.readVarString(decoder);\n};\n\nconst readYXmlFragment = (decoder) => {};\n\nconst readYXmlHook = (decoder) => {\n  decoding.readVarString(decoder);\n};\n\nconst readYXmlText = (decoder) => {};\n\nconst typeDecoder = [\n  readYArray,\n  readYMap,\n  readYText,\n  readYXmlElement,\n  readYXmlFragment,\n  readYXmlHook,\n  readYXmlText,\n];\n\nexport default typeDecoder;\n","/**\n * @since 2021-07-08\n * @author vivaxy\n */\nimport * as decoding from 'lib0/decoding';\nimport * as error from 'lib0/error';\nimport typeRefs from './type-decoder';\n\nfunction readContentDeleted(decoder) {\n  return {\n    type: 'deleted',\n    length: decoding.readVarUint(decoder),\n  };\n}\n\nfunction readContentEmbed(decoder) {\n  const embed = decoding.readVarString(decoder);\n  debugger;\n  return {\n    type: 'embed',\n    content: embed,\n    length: 1,\n  };\n}\n\nfunction readContentFormat(decoder) {\n  const key = decoding.readVarString(decoder);\n  const value = decoding.readVarString(decoder);\n  return {\n    type: 'format',\n    content: { key, value },\n    length: 1,\n  };\n}\n\nfunction readContentJSON(decoder) {\n  const length = decoding.readVarUint(decoder);\n  const content = [];\n  for (let i = 0; i < length; i++) {\n    const c = decoding.readVarString(decoder);\n    if (c === 'undefined') {\n      content.push(undefined);\n    } else {\n      content.push(JSON.parse(c));\n    }\n  }\n  return {\n    type: 'json',\n    content,\n    length,\n  };\n}\n\nfunction readContentString(decoder) {\n  const string = decoding.readVarString(decoder);\n  return {\n    type: 'string',\n    string,\n    length: string.length,\n  };\n}\n\nfunction readContentType(decoder) {\n  const contentType = typeRefs[decoding.readVarUint(decoder)](decoder);\n  return {\n    type: 'type',\n    content: contentType,\n    length: 1,\n  };\n}\n\nfunction readContentBinary(decoder) {\n  const binary = decoding.readVarUint8Array(decoder);\n  return {\n    type: 'binary',\n    content: binary,\n    length: 1,\n  };\n}\n\nfunction readContentAny(decoder) {\n  const len = decoding.readVarUint(decoder);\n  const content = [];\n\n  for (let i = 0; i < len; i++) {\n    const con = decoding.readAny(decoder);\n    content.push(con);\n  }\n\n  return {\n    type: 'any',\n    content,\n    length: len,\n  };\n}\n\nconst contentDecoder = [\n  () => {\n    throw error.unexpectedCase();\n  }, // GC is not ItemContent\n  readContentDeleted,\n  readContentJSON,\n  readContentBinary,\n  readContentString,\n  readContentEmbed,\n  readContentFormat,\n  readContentType,\n  readContentAny,\n];\n\nexport default contentDecoder;\n","/**\n * @since 2021-07-08\n * @author vivaxy\n */\nimport * as decoding from 'lib0/decoding';\n\nexport default function readDeleteSet(decoder) {\n  if (!(decoder instanceof decoding.Decoder)) {\n    decoder = decoding.createDecoder(decoder);\n  }\n  const ds = {\n    clients: {},\n  };\n  const numClients = decoding.readVarUint(decoder);\n  for (let i = 0; i < numClients; i++) {\n    const client = decoding.readVarUint(decoder);\n    const numberOfDeletes = decoding.readVarUint(decoder);\n    if (numberOfDeletes > 0) {\n      ds.clients[client] = [];\n      for (let i = 0; i < numberOfDeletes; i++) {\n        ds.clients[client].push({\n          clock: decoding.readVarUint(decoder),\n          length: decoding.readVarUint(decoder),\n        });\n      }\n    }\n  }\n  return ds;\n}\n","/**\n * @since 2021-07-08\n * @author vivaxy\n */\nimport * as decoding from 'lib0/decoding';\nimport * as binary from 'lib0/binary';\nimport contentRefs from './content-decoder';\nimport readDeleteSet from './delete-set-decoder';\n\nexport default function decode(clientID, decoder) {\n  if (!(decoder instanceof decoding.Decoder)) {\n    decoder = decoding.createDecoder(decoder);\n  }\n  const structRefs = readClientsStructRefs(decoder);\n\n  const clientData = structRefs[clientID];\n\n  const deleteSet = readDeleteSet(decoder);\n\n  if (!clientData) {\n    if (Object.keys(deleteSet.clients).length) {\n      return { clientID, deleteSet };\n    }\n    return { clientID };\n  }\n  const clock = clientData.items[0].clock;\n  const totalLength = clientData.totalLength;\n\n  if (Object.keys(deleteSet.clients).length) {\n    return {\n      clock,\n      clientID,\n      totalLength,\n      items: clientData.items,\n      deleteSet,\n    };\n  }\n  return {\n    clock,\n    clientID,\n    totalLength,\n    items: clientData.items,\n  };\n}\n\nfunction readClientsStructRefs(decoder) {\n  const clientRefs = {};\n  const numOfStateUpdates = decoding.readVarUint(decoder);\n  let totalLength = 0;\n  for (let i = 0; i < numOfStateUpdates; i++) {\n    const numberOfStructs = decoding.readVarUint(decoder);\n    const items = [];\n    let { clock, client } = readID(decoder);\n\n    for (let i = 0; i < numberOfStructs; i++) {\n      const info = decoding.readUint8(decoder);\n      let struct;\n      if ((binary.BITS5 & info) !== 0) {\n        struct = readItem(client, clock, decoder, info);\n      } else {\n        struct = new Item(client, clock, {\n          length: decoding.readVarUint(decoder),\n        });\n      }\n      items.push(struct);\n      clock += struct.length;\n      totalLength += struct.length;\n    }\n    clientRefs[client] = {\n      items,\n      totalLength,\n    };\n  }\n  return clientRefs;\n}\n\nfunction readID(decoder) {\n  return {\n    client: decoding.readVarUint(decoder),\n    clock: decoding.readVarUint(decoder),\n  };\n}\n\nclass Item {\n  constructor(\n    client,\n    clock,\n    content,\n    left,\n    origin,\n    right,\n    rightOrigin,\n    parentYKey,\n    parent,\n  ) {\n    this.client = client;\n    this.clock = clock;\n    this.left = left;\n    this.origin = origin;\n    this.right = right;\n    this.rightOrigin = rightOrigin;\n    this.parentYKey = parentYKey;\n    this.parent = parent;\n    Object.keys(content).forEach((key) => {\n      this[key] = content[key];\n    });\n  }\n}\n\nfunction readItem(client, clock, decoder, info) {\n  const origin = (info & binary.BIT8) === binary.BIT8 ? readID(decoder) : null;\n  const rightOrigin =\n    (info & binary.BIT7) === binary.BIT7 ? readID(decoder) : null;\n  const canCopyParentInfo = (info & (binary.BIT7 | binary.BIT8)) === 0;\n\n  const hasParentYKey = canCopyParentInfo\n    ? decoding.readVarUint(decoder) === 1\n    : false;\n\n  const parentYKey =\n    // parentYKey\n    canCopyParentInfo && hasParentYKey ? decoding.readVarString(decoder) : null;\n\n  let parent = null;\n  if (canCopyParentInfo && !hasParentYKey) {\n    // parent\n    parent = readID(decoder);\n  }\n\n  if (canCopyParentInfo && (info & binary.BIT6) === binary.BIT6) {\n    decoding.readVarString(decoder);\n  }\n\n  const itemContent = readItemContent(decoder, info);\n\n  return new Item(\n    client,\n    clock,\n    itemContent,\n    null,\n    origin,\n    null,\n    rightOrigin,\n    parentYKey,\n    parent,\n  );\n}\n\nfunction readItemContent(decoder, info) {\n  return contentRefs[info & binary.BITS5](decoder);\n}\n","import { useState } from 'react';\nimport * as Y from 'yjs';\n\nimport Scenarios from './components/Scenarios';\nimport Doc from './components/Doc';\nimport Actions from './components/Actions';\nimport scenarios from './scenarios';\nimport * as EDIT_TYPE from './enums/edit-types';\nimport * as Y_DOC_KEYS from './enums/y-doc-keys';\nimport * as E from './enums/event-types.js';\nimport * as ENUMS from './enums/enums';\nimport { sleep } from './helpers';\nimport decodeUpdate from './update-decoder';\nimport decodeDeleteSet from './update-decoder/delete-set-decoder';\n\nimport './App.css';\n\nconst SCENARIO_QUERY_KEY = 'scenario';\n\nfunction getURLQuery(key) {\n  const url = new URL(window.location.href);\n  const searchParams = url.searchParams;\n  return searchParams.get(key);\n}\n\nexport default function App() {\n  // url like ?scenario=TwoDocsSyncWithoutConflicts\n  const [currentScenario, setCurrentScenario] = useState(\n    getURLQuery(SCENARIO_QUERY_KEY) || ENUMS.CUSTOM_SCENARIO,\n  );\n  const [currentScenarioStepIndex, setCurrentScenarioStepIndex] = useState(0);\n  const [docs, _setDocs] = useState([]);\n  const [options, setOptions] = useState({\n    gc: false,\n    pud: false,\n  });\n\n  function setDocs(docs) {\n    _setDocs(docs);\n    window.docs = docs;\n  }\n\n  async function updateDocById(id, updateDoc) {\n    const newDocs = [\n      ...docs.slice(0, id),\n      await updateDoc(docs[id]),\n      ...docs.slice(id + 1),\n    ];\n    setDocs(newDocs);\n  }\n\n  function handleScenarioChange(scenario) {\n    setCurrentScenario(scenario);\n    setCurrentScenarioStepIndex(0);\n    setDocs([]);\n  }\n\n  async function handleNextStep() {\n    setCurrentScenarioStepIndex(currentScenarioStepIndex + 1);\n    const currentScenarioSteps = scenarios[currentScenario];\n    const [action, payload] = currentScenarioSteps[currentScenarioStepIndex];\n    switch (action) {\n      case E.DOC_OPEN:\n        await handleOpenDoc();\n        break;\n      case E.DOC_UPDATE:\n        await handleEditorChange(payload);\n        break;\n      case E.DOC_SYNC:\n        await handleSync(payload);\n        break;\n      case E.DOC_CLOSE:\n        await handleCloseDoc(payload);\n        break;\n      default:\n        throw new Error('Unexpected action: ' + action);\n    }\n  }\n\n  function handleRestartStep() {\n    setCurrentScenarioStepIndex(0);\n    setDocs([]);\n  }\n\n  async function handleOpenDoc() {\n    const yDoc = new Y.Doc();\n    yDoc.gc = options.gc;\n    const id = docs.length;\n\n    let pud = null;\n    if (options.pud) {\n      pud = new Y.PermanentUserData(yDoc);\n      /**\n       * cannot put setUserMapping and applyUpdate in one transaction\n       * setUserMapping comes from local but applyUpdate comes from remote\n       */\n      pud.setUserMapping(yDoc, yDoc.clientID, `Doc${id}`);\n      // setUserMapping use setTimeout to update pud\n      await sleep(0);\n    }\n\n    const update = Y.encodeStateAsUpdate(yDoc);\n    // when create doc, sync from the first doc\n    const validDocs = docs.filter(Boolean);\n    if (validDocs.length && id !== validDocs[0].id) {\n      Y.applyUpdate(yDoc, Y.encodeStateAsUpdate(validDocs[0].yDoc));\n    }\n    // sync to other docs\n    validDocs.forEach(function (doc) {\n      Y.applyUpdate(doc.yDoc, update);\n    });\n    setDocs([\n      ...docs,\n      {\n        id,\n        yDoc, // mutable\n        pud,\n        updates: [], // { action, payload }\n      },\n    ]);\n  }\n\n  async function handleCloseDoc(doc) {\n    doc.yDoc.destroy();\n    await updateDocById(doc.id, function () {\n      return null;\n    });\n  }\n\n  async function handleEditorChange(change) {\n    const { id, actions } = change;\n    await updateDocById(id, async function (doc) {\n      let newUpdates = [];\n      const prevStateVector = Y.encodeStateVector(doc.yDoc);\n      for (let i = 0; i < actions.length; i++) {\n        const action = actions[i];\n        const { type, pos, str, len } = action;\n        const yText = doc.yDoc.getText(Y_DOC_KEYS.TEXT_KEY);\n        switch (type) {\n          case EDIT_TYPE.INSERT:\n            yText.insert(pos, str);\n            break;\n          case EDIT_TYPE.DELETE:\n            yText.delete(pos, len);\n            break;\n          default:\n            throw new Error('Unexpected type');\n        }\n        await sleep(0);\n        const update = Y.encodeStateAsUpdate(doc.yDoc, prevStateVector);\n        const decodedUpdate = decodeUpdate(doc.yDoc.clientID, update);\n        decodedUpdate.items?.forEach(function (item) {\n          if (item.type === 'binary') {\n            const deleteSet = decodeDeleteSet(item.content);\n            if (Object.keys(deleteSet).length) {\n              item.decodedContent = deleteSet;\n            }\n            item.content = '[...]';\n          }\n        });\n        console.log('update', decodedUpdate);\n        newUpdates.push({\n          action,\n          payload: update,\n          syncedIds: [id],\n        });\n      }\n      if (docs.length === 1) {\n        // do not record updates when there is only one doc.\n        return doc;\n      }\n      return {\n        ...doc,\n        updates: [...doc.updates, ...newUpdates],\n      };\n    });\n  }\n\n  async function handleSync({ from, to, index }) {\n    await updateDocById(from, function (doc) {\n      if (!doc) {\n        return;\n      }\n      const toDoc = docs[to];\n      const toSyncUpdates =\n        index === undefined ? doc.updates : [doc.updates[index]];\n      toSyncUpdates.forEach(function (update) {\n        Y.applyUpdate(toDoc.yDoc, update.payload);\n      });\n      return {\n        ...doc,\n        updates: doc.updates\n          .map(function (update) {\n            if (toSyncUpdates.includes(update)) {\n              if (update.syncedIds.includes(to)) {\n                return update;\n              }\n              return {\n                ...update,\n                syncedIds: [...update.syncedIds, to],\n              };\n            }\n            return update;\n          })\n          .filter(function (update) {\n            return update.syncedIds.length !== docs.filter(Boolean).length;\n          }),\n      };\n    });\n  }\n\n  function handleOptionChange(changedOption) {\n    setOptions({\n      ...options,\n      ...changedOption,\n    });\n  }\n\n  const editable = currentScenario === ENUMS.CUSTOM_SCENARIO;\n\n  return (\n    <div className=\"App\">\n      <Scenarios\n        scenarios={scenarios}\n        currentScenario={currentScenario}\n        currentScenarioStepIndex={currentScenarioStepIndex}\n        onScenarioChange={handleScenarioChange}\n        onNextStep={handleNextStep}\n        onRestartStep={handleRestartStep}\n        onOpenDoc={handleOpenDoc}\n      />\n      {!scenarios[currentScenario] && (\n        <Actions\n          onOpenDoc={handleOpenDoc}\n          options={options}\n          disabled={!!docs.filter(Boolean).length}\n          onOptionChange={handleOptionChange}\n        />\n      )}\n      <div className=\"docs-container\">\n        {docs.filter(Boolean).map(function (doc) {\n          return (\n            <Doc\n              key={doc.id}\n              doc={doc}\n              docs={docs}\n              editable={editable}\n              onCloseDoc={handleCloseDoc}\n              onEditorChange={handleEditorChange}\n              onSync={handleSync}\n            />\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n","/**\n * @author vivaxy\n * @since 2021-07-08\n */\n\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root'),\n);\n"],"sourceRoot":""}